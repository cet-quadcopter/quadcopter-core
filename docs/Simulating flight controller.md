Simulating flight controller using AirSim
====

## Prerequisites
1. ROS melodic
2. Python pip `sudo apt install python-pip`

## Setup

### Create new catkin workspace

``` sh
mkdir drone_workspace
cd drone_workspace
git clone https://github.com/cet-quadcopter/quadcopter-core.git src
```

### Update rosdep registry and download dependencies
``` sh
cd src
./setup.sh
```

### Build and source workspace
```sh
cd ..
catkin_make
source devel/setup.bash
```

## Airsim simulator
[AirSim](https://github.com/microsoft/AirSim) is an open source simulator for autonomous vehicles built on Unreal Engine / Unity, from Microsoft. AirSim can be used for simulating drones, cars and more.

Airsim have inbuilt integration with ROS which can be used for directly controlling the velocity of drone. But for simulating flight controller, we need to control the angular velocity of propellers. Also we need data from sensors like accelerometer, gyro, magnetometer etc for control algorithm to work. Unfortunately the inbuilt Airsim ROS integration does not provide these required functionalities.

So we developed [airsim_mavlink_interceptor](https://github.com/cet-quadcopter/quadcopter-core/tree/master/airsim_mavlink_interceptor) package. This package can be used for reading data from and sending commands to airsim simulator by publishing / subscribing to respective topics.

To read sensor data from airsim simulator, subscribe to following ROS topics

| Sensor        | Topic                  | Format |
| :-------------: |----------------------  |--------|
| Accelerometer | /sensors/accelerometer | [Accelerometer.msg](https://github.com/cet-quadcopter/quadcopter-core/blob/master/drone_std_msgs/msg/Accelerometer.msg) |
| Barometer     | /sensors/barometer     | [Barometer.msg](https://github.com/cet-quadcopter/quadcopter-core/blob/master/drone_std_msgs/msg/Barometer.msg) |
| Compass       | /sensors/compass       | [Compass.msg](https://github.com/cet-quadcopter/quadcopter-core/blob/master/drone_std_msgs/msg/Compass.msg) |
| GPS           | /sensors/gps           | [GPS.msg](https://github.com/cet-quadcopter/quadcopter-core/blob/master/drone_std_msgs/msg/GPS.msg) |
| Gyro          | /sensors/gyro          | [Gyro.msg](https://github.com/cet-quadcopter/quadcopter-core/blob/master/drone_std_msgs/msg/Gyro.msg) |

For sending commands to airsim simulator, publish to following ROS topics

| Actuator | Topic | Format |
| :-----:| ------ | ------ |
| Propeller | /actuators/propeller | [Propeller.msg](https://github.com/cet-quadcopter/quadcopter-core/blob/master/drone_std_msgs/msg/Propeller.msg) |
| External force or torque | /actuators/wrench | [Wrench.msg](https://github.com/cet-quadcopter/quadcopter-core/blob/master/drone_std_msgs/msg/Wrench.msg) |

The catkin package [airsim_launcher](https://github.com/cet-quadcopter/quadcopter-core/tree/master/airsim_launcher) provides the functionality for automatically downloading, setting up and running the airsim simulator. To start airsim simulator run command

```sh
rosrun airsim_launcher start
```
`roscore` must be running for the above command to work

For viewing messages from simulator, we can subscribe to respective topic. For example, to view accelerometer data

```sh
rostopic echo /sensors/accelerometer
```

The output will be of below format. `ax`, `ay`, `az` is the acceleromter readings in x, y and z axis of body frame of drone.

```
---
ax: -0.0210692770779
ay: -0.0365246459842
az: -9.83548545837
---
ax: 0.0211030077189
ay: 0.0223048832268
az: -9.86950492859
---
ax: -0.0255417618901
ay: -0.0196655355394
az: -9.80732440948
---
```

To send commands to simulator, we can publish to respective topic. For example, to rotate all propeller at `0.5 x max angular velocity of propeller`,

``` sh
rostopic pub /actuators/propeller drone_std_msgs/Propeller "prop1: 0.5
prop2: 0.5
prop3: 0.5
prop4: 0.5"
```

## Create flight controller

The following steps will create a flight controller in `python` programming language which will maintain the drone at a particular height by reading `GPS` sensor data and sending `Propeller` angular velocity to simulator.

Create flight controller catkin package

```sh
catkin_create_pkg tutorial_controller rospy
cd tutorial_controller/
```

Create the flight controller node

```sh
mkdir scripts
cd scripts
gedit controller.py
```

Copy below to `controller.py`

```python
#!/usr/bin/env python 

import rospy as ros
from drone_std_msgs.msg import Propeller, GPS

propeller_pub = ros.Publisher('/actuators/propeller', Propeller, queue_size=10)

def gps_handler(msg):
    target_height = 124348
    current_height = msg.alt

    propeller_speed = 0.49

    # When propeller speed is above 0.5, thrust generated by the propeller 
    # will be greater than weight of drone. So if current drone height
    # is less than required height, set propeller speed to 0.51, else 
    # set to 0.49
    if current_height < target_height:
        propeller_speed = 0.51

    msg = Propeller(propeller_speed, propeller_speed, propeller_speed, propeller_speed)
    propeller_pub.publish(msg)


if __name__ == '__main__':
    ros.init_node('tutorial_controller')
    ros.Subscriber('/sensors/gps', GPS, gps_handler)

    ros.spin()

```

Make script executable

```sh
chmod +x ./controller.py
```

Start airsim simulator in new terminal window. Be sure to source to `drone_workspace`

```sh
rosrun airsim_launcher start
```

Start flight controller

```sh
rosrun tutorial_controller controller.py
```

For more advanced flight controller implementation, see [position control](https://github.com/cet-quadcopter/quadcopter-core/blob/master/airsim_mavlink_interceptor/scripts/altitude_lock.py) and [velocity control](https://github.com/cet-quadcopter/quadcopter-core/tree/master/falcon) implementations in `python` and `c++` respectively
